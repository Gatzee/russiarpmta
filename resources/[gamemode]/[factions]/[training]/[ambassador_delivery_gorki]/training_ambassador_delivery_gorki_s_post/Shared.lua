CONST_REWARD_EXP = 300

CONST_POST_INFO = {
	{
		position = Vector3( 2385.6001, -1715.1, 60.5 );
		objects = {
			{
				model = 1238;
				position = Vector3( 2392.3999, -1709.5, 59.8 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2389.8, -1710, 60 );
				rotation = Vector3( 0, 0, 102 );
			};
			{
				model = 1238;
				position = Vector3( 2387.3, -1710.4, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2385.3999, -1710.8, 60 );
				rotation = Vector3( 0, 0, 99.998 );
			};
			{
				model = 1238;
				position = Vector3( 2383.3, -1711.1, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2381.1001, -1711.5, 60 );
				rotation = Vector3( 0, 0, 101.998 );
			};
			{
				model = 1238;
				position = Vector3( 2378.6001, -1712, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 2093.6, -269.5, 60.5 );
		objects = {
			{
				model = 1238;
				position = Vector3( 2113.2, -258.5, 59.8 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2112.8, -261, 59.8 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2112.7, -263.5, 59.8 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2108.8999, -267.79999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2106.3999, -269, 60 );
				rotation = Vector3( 0, 0, 296 );
			};
			{
				model = 1238;
				position = Vector3( 2104.1001, -270.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2102.3999, -271, 60 );
				rotation = Vector3( 0, 0, 295.999 );
			};
			{
				model = 1238;
				position = Vector3( 2100.7, -271.90002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 2098.5, -273, 60 );
				rotation = Vector3( 0, 0, 295.999 );
			};
			{
				model = 1238;
				position = Vector3( 2096.2, -274.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2089.2, -268.29999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2087.8, -265.79999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2086.3, -263.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2084.8, -260.5, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2083.3, -257.79999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 2081.8, -255.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 1957.3, -183.5, 60.6 );
		objects = {
			{
				model = 1238;
				position = Vector3( 1946.3, -180.09998, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1948.5, -178.90002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1950.6, -177.90002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1952.7, -176.79999, 60 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1954.1, -176.09998, 60 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1956.4, -174.90002, 60 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1958.5, -173.79999, 60 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1960.5, -172.79999, 60 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 1960.3, -205.09998, 60.6 );
		objects = {
			{
				model = 1238;
				position = Vector3( 1987.2, -191.40002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1984.3, -193, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1981.4, -194.40002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1978.6, -195.70001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1975.9, -197.09998, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1972.9, -198.59998, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1970, -200.29999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1967.1, -202, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1963.9, -204, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1960.9, -206.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1958.7, -207.90002, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 1716.1, -605.39999, 60.5 );
		objects = {
			{
				model = 1238;
				position = Vector3( 1722, -589.10001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1721.8, -592, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1721.8, -595.20001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1721.7, -598.70001, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1721.6, -602.29999, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1721.6, -606, 59.9 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 1507.2, -894.7, 31.3 );
		objects = {
			{
				model = 1238;
				position = Vector3( 1511, -902.4, 30.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1508.3, -900.3, 30.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1505.1, -897.8, 30.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 1509.6, -901.5, 30.2 );
				rotation = Vector3( 0, 0, 54 );
			};
			{
				model = 1228;
				position = Vector3( 1506.6, -899.2, 30.2 );
				rotation = Vector3( 0, 0, 51.998 );
			};
			{
				model = 1228;
				position = Vector3( 1503.2159, -896.60109, 30.18867 );
				rotation = Vector3( 0, 0, 51.993 );
			};
			{
				model = 1238;
				position = Vector3( 1501.7, -895.4, 30.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 1498.8, -892.9, 30.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 1500.1, -894.2, 30.2 );
				rotation = Vector3( 0, 0, 51.993 );
			};
		};
	};
}

QUEST_DATA = {
	training_id = "ambassador_delivery_gorki";
	training_role = "s_post";
	training_parent = "driver";
	
	training_uncritical = true;

	title = "Сопровождение посла (Горки)";
	role_name = "Постовой";
	
	tasks = {
		[1] = {
			name = "Поговори с лейтенантом";

			Setup = {
				client = function( data )
					CreateQuestPointToNPCWithDialog( 19, {
						{
							text = [[— Здравия желаю! Наша задача сопроводить посла,
									в целости и сохранности. Есть вероятность
									нападения со стороны преступных группировок.]];
						};
						{
							text = [[Твоя задача перекрыть проезжую часть по маршруту
									движения посла, для оказания беспрепятственного
									проезда одной или двух государственных машин.
									После чего доложить водителю посла.]];
							info = true;
						};
						{
							text = [[Ты не являешься ключевых игроком данного
									учения. Твоя смерть или выход из игры
									не повлияют на процесс учений, но если
									посол или водитель будут убиты, то учение
									будет автоматически провалено!]];
							info = true;
						};
					}, "training_ambassador_delivery_gorki_s_post_end_step_1", _, true )
				end;
			};
		};
		[2] = {
			name = "Прибудь на пост";

			Setup = {
				client = function( data )
					CreateQuestPoint( CONST_POST_INFO[ data.slot % #CONST_POST_INFO + 1 ].position, "training_ambassador_delivery_gorki_s_post_end_step_2", _, 8, 0, 0 )
				end;
			};
		};
		[3] = {
			name = "Расставь ограждения";

			Setup = {
				client = function( data )
					addEvent( "training_ambassador_delivery_gorki_CreatePointToPutBarrier", true )
					addEventHandler( "training_ambassador_delivery_gorki_CreatePointToPutBarrier", localPlayer, Client_CreatePointToPutBarrier )

					Client_CreatePointToPutBarrier( data.slot % #CONST_POST_INFO + 1, 1 )
				end;

				server = function( player, data )
					addEvent( "training_ambassador_delivery_gorki_CreateObjectBarrier", true )
					addEventHandler( "training_ambassador_delivery_gorki_CreateObjectBarrier", player, Server_CreateObjectBarrier )
				end;
			};

			CleanUp = {
				client = function( data )
					removeEventHandler( "training_ambassador_delivery_gorki_CreatePointToPutBarrier", localPlayer, Client_CreatePointToPutBarrier )
				end;

				server = function( player, data )
					removeEventHandler( "training_ambassador_delivery_gorki_CreateObjectBarrier", player, Server_CreateObjectBarrier )
				end;
			};
		};
		[4] = {
			name = "Убери ограждения";
			requests = {
				{ "driver", 3 };
			};

			Setup = {
				client = function( data )
					addEvent( "training_ambassador_delivery_gorki_CreatePointToPickupBarrier", true )
					addEventHandler( "training_ambassador_delivery_gorki_CreatePointToPickupBarrier", localPlayer, Client_CreatePointToPickupBarrier )

					local number = data.slot % #CONST_POST_INFO + 1
					Client_CreatePointToPickupBarrier( number, #CONST_POST_INFO[ number ].objects )
				end;

				server = function( player, data )
					addEvent( "training_ambassador_delivery_gorki_DeleteObjectBarrier", true )
					addEventHandler( "training_ambassador_delivery_gorki_DeleteObjectBarrier", player, Server_DeleteObjectBarrier )
				end;
			};

			CleanUp = {
				client = function( data )
					removeEventHandler( "training_ambassador_delivery_gorki_CreatePointToPickupBarrier", localPlayer, Client_CreatePointToPickupBarrier )
				end;

				server = function( player, data )
					removeEventHandler( "training_ambassador_delivery_gorki_DeleteObjectBarrier", player, Server_DeleteObjectBarrier )
				end;
			};
		};
	};

	rewards = {
		faction_exp = CONST_REWARD_EXP;
	};

	success_text = "Задача выполнена! Вы получили +".. CONST_REWARD_EXP .." очков ранга";
}


function Client_CreatePointToPutBarrier( number, barrier_index )
	CreateQuestPoint( CONST_POST_INFO[ number ].objects[ barrier_index ].position, function()
		CEs.marker:destroy()
		triggerServerEvent( "training_ambassador_delivery_gorki_CreateObjectBarrier", localPlayer, number, barrier_index )
	end, _, 2, 0, 0 )
end

function Server_CreateObjectBarrier( number, barrier_index )
	if not client then return end

	local barrier_info = CONST_POST_INFO[ number ].objects[ barrier_index ]

	local world_object = Object( barrier_info.model, barrier_info.position, barrier_info.rotation )
	world_object.frozen = true
	AddQuestElement( client, "world_object_".. barrier_index, world_object )

	setPedAnimation( client, "bomber", "bom_plant_loop", -1, false, false, false, false )

	if barrier_index == #CONST_POST_INFO[ number ].objects then
		triggerEvent( "training_ambassador_delivery_gorki_s_post_end_step_3", client )
	else
		triggerClientEvent( client, "training_ambassador_delivery_gorki_CreatePointToPutBarrier", client, number, barrier_index + 1 )
	end
end


function Client_CreatePointToPickupBarrier( number, barrier_index )
	CreateQuestPoint( CONST_POST_INFO[ number ].objects[ barrier_index ].position, function()
		CEs.marker:destroy()
		triggerServerEvent( "training_ambassador_delivery_gorki_DeleteObjectBarrier", localPlayer, number, barrier_index )
	end, _, 2, 0, 0 )
end

function Server_DeleteObjectBarrier( number, barrier_index )
	if not client then return end

	DeleteQuestElement( client, "world_object_".. barrier_index )

	setPedAnimation( client, "bomber", "bom_plant_loop", -1, false, false, false, false )

	if barrier_index == 1 then
		triggerEvent( "training_ambassador_delivery_gorki_s_post_end_step_4", client )
	else
		triggerClientEvent( client, "training_ambassador_delivery_gorki_CreatePointToPickupBarrier", client, number, barrier_index - 1 )
	end
end