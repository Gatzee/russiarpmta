CONST_REWARD_EXP = 300

CONST_POST_INFO = {
	{
		position = Vector3( 228.89999, -2325.3, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( 229.5, -2331.3, 20.2 );
				rotation = Vector3( 0, 0, 85 );
			};
			{
				model = 1238;
				position = Vector3( 230.89999, -2337.6, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 229.60001, -2334.9, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 228.39999, -2332.6, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 227, -2329.6, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 222.89999, -2329.1, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 225.10001, -2329.5, 20.2 );
				rotation = Vector3( 0, 0, 85 );
			};
		};
	};
	{
		position = Vector3( 246.39999, -1907.7, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( 243.5, -1903.9, 20.2 );
				rotation = Vector3( 0, 0, 90 );
			};
			{
				model = 1238;
				position = Vector3( 240.3, -1899.3, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 241.5, -1901.8, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 245.39999, -1901.9, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 248, -1902.1, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 250.10001, -1903.8, 20.2 );
				rotation = Vector3( 0, 0, 90 );
			};
			{
				model = 1238;
				position = Vector3( 251.8, -1902.2, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 253, -1900, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( 277.89999, -1922.9, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( 283.20001, -1920.2, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 287.10001, -1917.9, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.70001, -1918.7, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.70001, -1921.6, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.70001, -1923.2, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 283.20001, -1925.1, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.60001, -1926.8, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.5, -1929.3, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 282.89999, -1930.9, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.29999, -1932.5, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.20001, -1934.2, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( 282.89999, -1935.7, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 284.10001, -1937.3, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( 286.10001, -1938.2, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( -47.8, -1964.4, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( -44.4, -1968, 20.2 );
				rotation = Vector3( 0, 0, 90 );
			};
			{
				model = 1238;
				position = Vector3( -41.8, -1971.5, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -42.9, -1969.5, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -45.7, -1969.4, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( -49.2, -1968, 20.2 );
				rotation = Vector3( 0, 0, 90 );
			};
			{
				model = 1238;
				position = Vector3( -47.2, -1969.4, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -50.8, -1969.3, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -52.1, -1967.6, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -53.7, -1965.3, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -55.4, -1963, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -57, -1959.8, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -59.5, -1956.9, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -62.7, -1954.7, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -66.7, -1953.8, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -70.2, -1953.2, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -74, -1952.8, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( -887.09998, -1851.20001, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( -891, -1853.20001, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -894.20001, -1855.5, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -892.09998, -1854.79999, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -892.09998, -1851.59998, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -892.09998, -1850.09998, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( -890.79999, -1848.20001, 20.2 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -892, -1846, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
	{
		position = Vector3( -808.90002, -1724.40002, 20.8 );
		objects = {
			{
				model = 1228;
				position = Vector3( -802.90002, -1723.09998, 20.2 );
				rotation = Vector3( 0, 0, 348 );
			};
			{
				model = 1238;
				position = Vector3( -798.5, -1721.29999, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -801.40002, -1721.5, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1238;
				position = Vector3( -802.29999, -1725.40002, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
			{
				model = 1228;
				position = Vector3( -804.09998, -1727.5, 20.2 );
				rotation = Vector3( 0, 0, 347.997 );
			};
			{
				model = 1238;
				position = Vector3( -803.29999, -1729.70001, 20.1 );
				rotation = Vector3( 0, 0, 0 );
			};
		};
	};
}

QUEST_DATA = {
	training_id = "ambassador_delivery";
	training_role = "s_post";
	training_parent = "driver";
	
	training_uncritical = true;

	title = "Сопровождение посла";
	role_name = "Постовой";
	
	tasks = {
		[1] = {
			name = "Поговори с лейтенантом";

			Setup = {
				client = function( data )
					CreateQuestPointToNPCWithDialog( 18, {
						{
							text = [[— Здравия желаю! Наша задача сопроводить посла,
									в целости и сохранности. Есть вероятность
									нападения со стороны преступных группировок.]];
						};
						{
							text = [[Твоя задача перекрыть проезжую часть по маршруту
									движения посла, для оказания беспрепятственного
									проезда одной или двух государственных машин.
									После чего доложить водителю посла.]];
							info = true;
						};
						{
							text = [[Ты не являешься ключевых игроком данного
									учения. Твоя смерть или выход из игры
									не повлияют на процесс учений, но если
									посол или водитель будут убиты, то учение
									будет автоматически провалено!]];
							info = true;
						};
					}, "training_ambassador_delivery_s_post_end_step_1", _, true )
				end;
			};
		};
		[2] = {
			name = "Прибудь на пост";

			Setup = {
				client = function( data )
					CreateQuestPoint( CONST_POST_INFO[ data.slot % #CONST_POST_INFO + 1 ].position, "training_ambassador_delivery_s_post_end_step_2", _, 8, 0, 0 )
				end;
			};
		};
		[3] = {
			name = "Расставь ограждения";

			Setup = {
				client = function( data )
					addEvent( "training_ambassador_delivery_CreatePointToPutBarrier", true )
					addEventHandler( "training_ambassador_delivery_CreatePointToPutBarrier", localPlayer, Client_CreatePointToPutBarrier )

					Client_CreatePointToPutBarrier( data.slot % #CONST_POST_INFO + 1, 1 )
				end;

				server = function( player, data )
					addEvent( "training_ambassador_delivery_CreateObjectBarrier", true )
					addEventHandler( "training_ambassador_delivery_CreateObjectBarrier", player, Server_CreateObjectBarrier )
				end;
			};

			CleanUp = {
				client = function( data )
					removeEventHandler( "training_ambassador_delivery_CreatePointToPutBarrier", localPlayer, Client_CreatePointToPutBarrier )
				end;

				server = function( player, data )
					removeEventHandler( "training_ambassador_delivery_CreateObjectBarrier", player, Server_CreateObjectBarrier )
				end;
			};
		};
		[4] = {
			name = "Убери ограждения";
			requests = {
				{ "driver", 3 };
			};

			Setup = {
				client = function( data )
					addEvent( "training_ambassador_delivery_CreatePointToPickupBarrier", true )
					addEventHandler( "training_ambassador_delivery_CreatePointToPickupBarrier", localPlayer, Client_CreatePointToPickupBarrier )

					local number = data.slot % #CONST_POST_INFO + 1
					Client_CreatePointToPickupBarrier( number, #CONST_POST_INFO[ number ].objects )
				end;

				server = function( player, data )
					addEvent( "training_ambassador_delivery_DeleteObjectBarrier", true )
					addEventHandler( "training_ambassador_delivery_DeleteObjectBarrier", player, Server_DeleteObjectBarrier )
				end;
			};

			CleanUp = {
				client = function( data )
					removeEventHandler( "training_ambassador_delivery_CreatePointToPickupBarrier", localPlayer, Client_CreatePointToPickupBarrier )
				end;

				server = function( player, data )
					removeEventHandler( "training_ambassador_delivery_DeleteObjectBarrier", player, Server_DeleteObjectBarrier )
				end;
			};
		};
	};

	rewards = {
		faction_exp = CONST_REWARD_EXP;
	};

	success_text = "Задача выполнена! Вы получили +".. CONST_REWARD_EXP .." очков ранга";
}


function Client_CreatePointToPutBarrier( number, barrier_index )
	CreateQuestPoint( CONST_POST_INFO[ number ].objects[ barrier_index ].position, function()
		CEs.marker:destroy()
		triggerServerEvent( "training_ambassador_delivery_CreateObjectBarrier", localPlayer, number, barrier_index )
	end, _, 2, 0, 0 )
end

function Server_CreateObjectBarrier( number, barrier_index )
	if not client then return end

	local barrier_info = CONST_POST_INFO[ number ].objects[ barrier_index ]

	local world_object = Object( barrier_info.model, barrier_info.position, barrier_info.rotation )
	world_object.frozen = true
	AddQuestElement( client, "world_object_".. barrier_index, world_object )

	setPedAnimation( client, "bomber", "bom_plant_loop", -1, false, false, false, false )

	if barrier_index == #CONST_POST_INFO[ number ].objects then
		triggerEvent( "training_ambassador_delivery_s_post_end_step_3", client )
	else
		triggerClientEvent( client, "training_ambassador_delivery_CreatePointToPutBarrier", client, number, barrier_index + 1 )
	end
end


function Client_CreatePointToPickupBarrier( number, barrier_index )
	CreateQuestPoint( CONST_POST_INFO[ number ].objects[ barrier_index ].position, function()
		CEs.marker:destroy()
		triggerServerEvent( "training_ambassador_delivery_DeleteObjectBarrier", localPlayer, number, barrier_index )
	end, _, 2, 0, 0 )
end

function Server_DeleteObjectBarrier( number, barrier_index )
	if not client then return end

	DeleteQuestElement( client, "world_object_".. barrier_index )

	setPedAnimation( client, "bomber", "bom_plant_loop", -1, false, false, false, false )

	if barrier_index == 1 then
		triggerEvent( "training_ambassador_delivery_s_post_end_step_4", client )
	else
		triggerClientEvent( client, "training_ambassador_delivery_CreatePointToPickupBarrier", client, number, barrier_index - 1 )
	end
end