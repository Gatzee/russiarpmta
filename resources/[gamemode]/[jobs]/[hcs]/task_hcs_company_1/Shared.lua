CONST_BASE_POSITIONS = {
	[ 0 ] = Vector3( 353.148, -1627.886 + 860, 20.788 );
	[ 1 ] = Vector3( 2269.980, -1134.943 + 860, 60.761 );
}


CONST_HOUSES_POSITIONS = {
	[ 0 ] = {
		{
			Vector3( 97.658, -1567.901 + 860, 20.907 ),
			Vector3( 163.056, -1528.079 + 860, 20.908 ),
			Vector3( 105.496, -1513.315 + 860, 20.901 ),
			Vector3( 193.915, -1512.988 + 860, 20.908 ),
			Vector3( 142.319, -1542.01 + 860, 21.881 ),
			Vector3( 184.611, -1562.327 + 860, 20.901 ),
			Vector3( 205.661, -1541.81 + 860, 20.901 ),
			Vector3( 143.936, -1573.041 + 860, 20.907 ),
			Vector3( 205.447, -1565.033 + 860, 20.901 ),
			Vector3( 184.928, -1524.814 + 860, 20.901 ),
			Vector3( 118.535, -1522.917 + 860, 20.901 ),
		};
		{
			Vector3( 27.061, -1791.706 + 860, 20.977 ),
			Vector3( 45.829, -1828.37 + 860, 20.971 ),
			Vector3( 21.844, -1874.499 + 860, 20.971 ),
			Vector3( -8.572, -1902.582 + 860, 20.971 ),
			Vector3( -20.264, -1928.723 + 860, 20.971 ),
			Vector3( -51.217, -1889.13 + 860, 20.971 ),
			Vector3( -62.121, -1833.76 + 860, 20.971 ),
			Vector3( -72.48, -1792.869 + 860, 20.977 ),
			Vector3( -21.2, -1788.129 + 860, 20.977 ),
			Vector3( 15.494, -1787.747 + 860, 20.977 ),
		};
		{
			Vector3( -99.767, -1293.701 + 860, 20.653 ),
			Vector3( -47.354, -1293.647 + 860, 20.643 ),
			Vector3( -55.313, -1274.766 + 860, 20.635 ),
			Vector3( -29.122, -1284.296 + 860, 20.631 ),
			Vector3( -150.789, -1270.215 + 860, 20.606 ),
			Vector3( -107.881, -1275.081 + 860, 20.637 ),
			Vector3( -175.198, -1297.32 + 860, 20.729 ),
			Vector3( -207.328, -1280.022 + 860, 20.598 ),
			Vector3( -258.413, -1279.321 + 860, 20.598 ),
			Vector3( -270.147, -1269.028 + 860, 20.598 ),
			Vector3( -267.352, -1294.859 + 860, 20.598 ),
		};
	};
	[ 1 ] = {
		{
			Vector3( 2016.401, -976.276 + 860, 60.68 ),
			Vector3( 1946.894, -901.927 + 860, 60.675 ),
			Vector3( 1914.9, -904.418 + 860, 60.675 ),
			Vector3( 2007.76, -972.165 + 860, 60.68 ),
			Vector3( 1987.196, -927.614 + 860, 60.68 ),
			Vector3( 1908.591, -931.228 + 860, 62.371 ),
			Vector3( 2005.301, -915.052 + 860, 60.68 ),
			Vector3( 1889.607, -932.965 + 860, 60.677 ),
			Vector3( 1926.633, -922.58 + 860, 60.677 ),
		};
		{
			Vector3( 1889.426, -426.408 + 860, 60.748 ),
			Vector3( 1867.233, -412.074 + 860, 60.748 ),
			Vector3( 1833.43, -405.319 + 860, 60.748 ),
			Vector3( 1882.225, -405.356 + 860, 60.748 ),
			Vector3( 1860.029, -400.56 + 860, 60.748 ),
			Vector3( 1820.318, -402.138 + 860, 60.748 ),
			Vector3( 1816.673, -428.844 + 860, 60.748 ),
			Vector3( 1826.638, -474.967 + 860, 60.748 ),
			Vector3( 1802.204, -429.869 + 860, 60.748 ),
			Vector3( 1817.159, -488.379 + 860, 60.748 ),
			Vector3( 1802.075, -474.797 + 860, 60.748 ),
			Vector3( 1811.562, -411.874 + 860, 60.748 ),
			Vector3( 1833.253, -487.353 + 860, 60.748 ),
			Vector3( 1805.517, -459.658 + 860, 60.748 ),
			Vector3( 1832.379, -478.747 + 860, 60.748 ),
		};
		{
			Vector3( 2395.837, -776.553 + 860, 60.82 ),
			Vector3( 2367.184, -683.687 + 860, 60.82 ),
			Vector3( 2378.806, -718.967 + 860, 60.82 ),
			Vector3( 2363.524, -635.427 + 860, 60.82 ),
			Vector3( 2381.655, -656.695 + 860, 60.82 ),
			Vector3( 2392.545, -763.611 + 860, 60.82 ),
			Vector3( 2391.025, -689.18 + 860, 60.82 ),
			Vector3( 2382.144, -731.959 + 860, 60.827 ),
			Vector3( 2398.793, -713.865 + 860, 60.82 ),
			Vector3( 2358.549, -650.658 + 860, 60.82 ),
			Vector3( 2413.63, -818.474 + 860, 60.82 ),
			Vector3( 2396.114, -703.104 + 860, 60.82 ),
			Vector3( 2406.54, -738.106 + 860, 60.82 ),
			Vector3( 2426.455, -807.66 + 860, 60.82 ),
			Vector3( 2412.502, -758.442 + 860, 60.82 ),
			Vector3( 2418.374, -776.69 + 860, 60.82 ),
		};
	};
}

CONST_MARKERS_COUNT = 5

QUEST_DATA = {
	id = "task_hcs_company_1";

	title = "Ремонт зданий";
	description = "";

	CheckToStart = function( player )
		return player:GetJobClass( ) == JOB_CLASS_HCS
	end;

	replay_timeout = 0;

	tasks = {
		[1] = {
            name = "Выполни ремонт";

            Setup = {
				client = function()
					local city = localPlayer:GetShiftCity( )
					local points = CONST_HOUSES_POSITIONS[ city ][ math.random( 1, #CONST_HOUSES_POSITIONS[ city ] ) ]
					local offset = math.random( 1, #points )
					for i = 1, CONST_MARKERS_COUNT do
						CreateQuestPoint( points[ ( offset + i ) % #points + 1 ], 
							function()
								if isElement( localPlayer.vehicle ) then
									localPlayer:ShowError( "Сначала покинь транспортное средство" )
									return
								end

								createMiniGame( {
									[1] = {
										--осмотреть повреждения
										action = function()
											local element = ibCreateMouseKeyPress( {
												texture = "img/hint1.png",
												key = "lalt",
												callback = function()
													playSound( "sounds/idle_".. math.random( 1, 2 ) ..".wav" ).volume = 0.5
													localPlayer:setFrozen( true )
													localPlayer:setAnimation( "bomber", "bom_plant_loop", -1, true, false, false, false )
													createNextGameStep()
												end,
												check = function()
													if isElement( localPlayer.vehicle ) then
														return
													end

													if isElementWithinMarker( localPlayer, CEs[ "marker_" .. i ].marker ) then
														return true
													else
														localPlayer:ShowInfo("Вернись к точке!")
													end
												end,

												click_action = function()
													localPlayer:setAnimation( "sword", "sword_3", -1, false, false, false, false )
												end;
												timeout = 5000;
											} )
											return element
										end
									};
									[2] = {
										--взять инструменты
										action = function()
											local rand = math.random( 1, 3 )
											if rand == 1 then
												return ibCreateMouseKeyStrokeTimeout({
													texture = "img/hint3_1.png";
													key = "mouse2";

													check = function()
														if isElementWithinMarker( localPlayer, CEs[ "marker_" .. i ].marker ) then
															return true
														else
															localPlayer:ShowInfo("Вернись к точке!")
														end
													end;

													callback = function()
														playSound( "sounds/drill_".. math.random( 1, 2 ) ..".wav" ).volume = 0.5
														createNextGameStep()
													end;
												})
											elseif rand == 2 then
												return ibCreatePressInCircleRegion({
													texture = "img/hint3_2.png";
													key = "mouse2";

													check = function()
														if isElementWithinMarker( localPlayer, CEs[ "marker_" .. i ].marker ) then
															return true
														else
															localPlayer:ShowInfo("Вернись к точке!")
														end
													end;

													callback = function()
														playSound( "sounds/drill_".. math.random( 1, 2 ) ..".wav" ).volume = 0.5
														createNextGameStep()
													end;
												})
											else
												return ibCreateMouseKeyStroke({
													texture = "img/hint3_3.png";
													key = "mouse1";

													check = function()
														if isElementWithinMarker( localPlayer, CEs[ "marker_" .. i ].marker ) then
															return true
														else
															localPlayer:ShowInfo("Вернись к точке!")
														end
													end;

													callback = function()
														playSound( "sounds/drill_".. math.random( 1, 2 ) ..".wav" ).volume = 0.5
														createNextGameStep()
													end;
												})
											end
										end
									};
									[3] = {
										action = function()
											return ibCreateMouseKeyHold({
												sx = 487,
												sy = 34,
												rect_x = 123,
												rect_y = 0,
												rect_size = 85,
												hold_time = 1900,
												count_hold = 1,
												texture = "img/hint5.png",
												key = "mouse1",

												callback = function()
													playSound( "sounds/idle_".. math.random( 1, 2 ) ..".wav" ).volume = 0.5
													CEs[ "marker_" .. i ]:destroy()
													localPlayer:setFrozen( false )
													createNextGameStep()
													localPlayer:setAnimation( )

													for i = 1, CONST_MARKERS_COUNT do
														if isElement( CEs[ "marker_" .. i ].marker ) then
															return
														end
													end

													triggerServerEvent( "PlayerAction_Task_Hcs_1_step_1", localPlayer )
												end;

												check = function()
													if isElementWithinMarker( localPlayer, CEs[ "marker_" .. i ].marker ) then
														return true
													else
														localPlayer:ShowInfo("Вернись к точке!")
													end
												end;
											})
										end
									};
								} )
							end
						, "marker_" .. i, 1, 0, 0, _, _, _, "cylinder",230, 230, 0, 100 )
					end
				end
            },
			
			CleanUp = {
				client = function( )
					localPlayer:setAnimation( )
				end;
			},

            event_end_name = "PlayerAction_Task_Hcs_1_step_1";
		},

		[2] = {
            name = "Вернись в офис";

            Setup = {
				client = function()
					local city = localPlayer:GetShiftCity( )
					CreateQuestPoint( CONST_BASE_POSITIONS[ city ], function()
						if isElement( localPlayer.vehicle ) then
							localPlayer:ShowError( "Сначала покинь транспортное средство" )
							return
						end

						CEs.marker:destroy()
						triggerServerEvent( "PlayerAction_Task_Hcs_2_step_2", localPlayer )
					end, _, 10, 0, 0, false, false, false, "cylinder", 30, 160, 60, 50 )
				end,
				server = function( player )
					triggerEvent( "onHcsFinishedCutting", player )
				end,
            },

            event_end_name = "PlayerAction_Task_Hcs_2_step_2";
		},
	};
	
	GiveReward = function( player )
		StartAgain( player )
	end;

	no_show_rewards = true;
	no_show_success = true;
}	


function StartAgain( player )
	setTimer( function()
		if not isElement( player ) then return end
		triggerEvent( "onJobRequestAnotherTask", player, player, false )
	end, 100, 1 )
end
