-- Точки начала маршрута
ROUTE_START_POINTS = {
	[ 0 ] = { 
		{ position = Vector3( -1258.666, -1809.229 + 860, 20.833 ) },
	},
	[ 1 ] = {
		{ position = Vector3( -1050.39, 2211.21 + 860, 12.06 ) },
	},
}

-- Остановки
STOPS = {
	[ 0 ] = {
		[ 1 ] = {
			{ x = -1344.19, y = -1502.08 + 860, z = 19.85 },
			{ x = -1047.82, y = -1527.82 + 860, z = 19.79 },
			{ x = -855.1, y = -1756.06 + 860, z = 19.78 },
			{ x = -901.22, y = -1836.48 + 860, z = 19.78 },
			{ x = 31.79, y = -2307.31 + 860, z = 19.6 },
			{ x = 210.46, y = -2541.48 + 860, z = 19.6 },
			{ x = 477.01, y = -2325.92 + 860, z = 19.58 },
			{ x = 308.71, y = -2246.44 + 860, z = 19.59 },
			{ x = 253.11, y = -1474.97 + 860, z = 19.73 },
			{ x = 420.3, y = -1225.01 + 860, z = 19.59 },
			{ x = 477.04, y = -1208.24 + 860, z = 19.6 },
			{ x = 98.29, y = -1227.34 + 860, z = 19.6 },
			{ x = -30.9, y = -1244.81 + 860, z = 19.6 },
			{ x = -227.15, y = -1227.96 + 860, z = 19.6 },
			{ x = -282.62, y = -1386.84 + 860, z = 19.6 },
			{ x = -300.39, y = -1560.47 + 860, z = 19.8 },
			{ x = -282.8, y = -1885.99 + 860, z = 19.81 },
			{ x = -300.32, y = -1836.42 + 860, z = 19.81 },
			{ x = -468.03, y = -1712.97 + 860, z = 19.75 },
			{ x = -449.84, y = -1702.09 + 860, z = 19.77 },
			{ x = -232.38, y = -1944.32 + 860, z = 19.81 },
			{ x = 106.43, y = -1936.58 + 860, z = 19.74 },
			{ x = 194.98, y = -1918.54 + 860, z = 19.77 },
			{ x = 633.04, y = -1936.59 + 860, z = 19.74 },
			{ x = 440.02, y = -1376.66 + 860, z = 19.63 },
			{ x = 456.68, y = -1346.92 + 860, z = 19.77 },
			{ x = 241.97, y = -1535.39 + 860, z = 19.7 },
			{ x = 202.46, y = -2439.64 + 860, z = 19.6 },
			{ x = 34.82, y = -2264.69 + 860, z = 19.6 },
			{ x = -478.78, y = -1960.56 + 860, z = 19.79 },
			{ x = -646.55, y = -1943.72 + 860, z = 19.78 },
			{ x = -751.49, y = -1961.58 + 860, z = 19.78 },
			{ x = -849.73, y = -1826.17 + 860, z = 19.78 },
			{ x = -1211.35, y = -1517.83 + 860, z = 19.85 },
			{ x = -1293.25, y = -1527.72 + 860, z = 19.85 },
			{ x = -1255.24, y = -1223.72 + 860, z = 19.85 },
			{ x = -1175.16, y = -1314.53 + 860, z = 19.85 },
			{ x = -470.5, y = -1780.72 + 860, z = 19.79 },
			{ x = -113.03, y = -1437.61 + 860, z = 19.6 },
		},
	},
	[ 1 ] = {
		[ 1 ] = {
			-- msk
			{ x = -1038.2, y = 2163.47, z = 11.51 },
			{ x = -999.61, y = 1820.54, z = 7.3 },
			{ x = -823.84, y = 1830.41, z = 9.52 },
			{ x = -634.52, y = 1742.53, z = 7.29 },
			{ x = -366.14, y = 2385.28, z = 13.91 },
			{ x = -488.89, y = 2098.49, z = 13.91 },
			{ x = 839.46, y = 1835.72, z = 7.3 },
			{ x = -904.11, y = 2434.42, z = 17.07 },
			{ x = -541.31, y = 2715.25, z = 14.12 },
			{ x = -571.29, y = 2692.43, z = 14.29 },
			{ x = -674.4, y = 2461.71, z = 16.61 },
			{ x = -947.88, y = 2034.08, z = 10.81 },
			{ x = -1364.28, y = 2356.07, z = 10.11 },
			{ x = -1516.49, y = 2496.28, z = 9.5 },
			{ x = -1428.58, y = 2351.15, z = 9.5 },
			{ x = -1309.42, y = 2433.15, z = 11.07 },
			{ x = -851.59, y = 2182.53, z = 18.79 },
			{ x = -720.82, y = 2293.13, z = 18.92 },
			{ x = -418.71, y = 2295.06, z = 13.91 },
			{ x = -564.79, y = 2221.72, z = 14.64 },
			{ x = -303.14, y = 2550.63, z = 13.91 },
			{ x = -490.01, y = 2402.98, z = 14.64 },
			{ x = -781.17, y = 2152.34, z = 18.83 },
			{ x = -915.71, y = 2362.17, z = 17.15 },
			{ x = -845.17, y = 2538.94, z = 16.73 },
			{ x = -791.49, y = 2615.97, z = 16.59 },
			{ x = -709.11, y = 2528.64, z = 16.59 },
			{ x = -494.67, y = 2445.5, z = 14.86 },
			{ x = -150.57, y = 2789.59, z = 13.89 },
			{ x = 54.47, y = 2722.92, z = 17.73 },
			{ x = 160.95, y = 2707.31, z = 18.83 },
			{ x = 535.71, y = 2536.36, z = 13.5 },
			{ x = 1035.17, y = 2472.94, z = 11.07 },
			{ x = 1022.49, y = 2690.92, z = 7.86 },
			{ x = 1132.96, y = 2435.36, z = 10.11 },
			{ x = 1075.27, y = 2310.39, z = 10.77 },
			{ x = 1248.13, y = 2316.14, z = 8.75 },
			{ x = 1449.57, y = 2267.73, z = 8.37 },
			{ x = 1424.26, y = 2432.95, z = 9.1 },
			{ x = 642.17, y = 2424.03, z = 14.32 },
			{ x = 555.9, y = 2670.14, z = 10.8 },
			{ x = 982.08, y = 2797.01, z = 6.97 },
			{ x = 597, y = 2488.17, z = 12.72 },
			{ x = 657.82, y = 2295.98, z = 14.23 },
			{ x = 1425.44, y = 2336.46, z = 8.83 },
			{ x = 1549.05, y = 2637.7, z = 8.85 },
			{ x = 1465.81, y = 2602.71, z = 8.97 },
			{ x = 1388.66, y = 2137.26, z = 7.44 },
			{ x = 1155.52, y = 2153.88, z = 7.54 },
			{ x = 1109.57, y = 1848.97, z = 7.3 },
			{ x = 1055.02, y = 1772.49, z = 11.66 },

			-- city
			{ x = 2686.12, y = 2504.25, z = 6.87 },
			{ x = 2101.93, y = 2303.32, z = 6.87 },

			-- mo
			{ x = 178.88, y = 380.93, z = 19.7 },
			{ x = -248.91, y = 245.7, z = 19.7 },
			{ x = -534.65, y = 262.82, z = 19.7 },
			{ x = -795.02, y = 318.42, z = 19.7 },
			{ x = -442.56, y = 482.76, z = 19.7 },
			{ x = -248.71, y = 500.85, z = 19.7 },
			{ x = -131.86, y = 497.38, z = 19.7 }
		},
	},
}

-- Точки возврата к базе
RETURN_TARGETS = {
	-- НСК
	[ 0 ] = {
		{ position = Vector3( -1258.666, -1809.229 + 860, 20.833 ) },
	},
	-- МСК
	[ 1 ] = {
		{ position = Vector3( -1050.39, 2211.21, 12.06 ) },
	},
}

addEvent( "onDriverEarnMoney", true )

QUEST_DATA = {
	id = "task_driver_company";

	title = "Водитель автобуса";
	description = "";

	CheckToStart = function( player )
		return player:GetJobClass( ) == JOB_CLASS_DRIVER
	end;

	replay_timeout = 0;

	tasks = {
		[1] = {
			name = "Выедь из автобусного парка";

			Setup = {
				client = function()
					local city = localPlayer:GetShiftCity( )
					local start_points = ROUTE_START_POINTS[ city ]
					local start_point = start_points[ math.random( 1, #start_points ) ]

					CreateQuestPoint( start_point.position, 
						function()
							CEs.marker:destroy()
							triggerServerEvent( "PlayerAction_Task_Driver_1_step_1", localPlayer )
							if localPlayer.vehicle then localPlayer.vehicle:ping( ) end
						end
					, _, 10, 0, 0, CheckPlayerQuestVehicle, _, _, "cylinder", 0, 255, 0, 20 )
					CEs.marker.slowdown_coefficient = nil
				end;
			};
			event_end_name = "PlayerAction_Task_Driver_1_step_1";
			
		};

		[2] = {
			name = "Следуй по маршруту";

			Setup = {
				client = function()
					local city = localPlayer:GetShiftCity( )
					local stops = STOPS[ city ][ math.random( 1, #STOPS[ city ] ) ]
					createStops( stops )
					if localPlayer.vehicle then localPlayer.vehicle:ping( ) end
				end;
			};
			CleanUp = {
				client = function( )
					destroyStops( )
				end;
			};
			event_end_name = "PlayerAction_Task_Driver_1_step_2";
		},

		[3] = {
			name = "Вернись к депо";

			Setup = {
				client = function()
					local city = localPlayer:GetShiftCity( )
					local return_targets = RETURN_TARGETS[ city ]
					local return_point = return_targets[ math.random( 1, #return_targets ) ]

					CreateQuestPoint( return_point.position, 
						function()
							CEs.marker:destroy()
							triggerServerEvent( "PlayerAction_Task_Driver_1_step_3", localPlayer )
							if localPlayer.vehicle then localPlayer.vehicle:ping( ) end
						end
					, _, 10, 0, 0, false, _, _, "cylinder", 0, 255, 0, 20 )
					CEs.marker.slowdown_coefficient = nil
				end,
			};
			CleanUp = {
				server = function( player )
					local vehicle = player.vehicle
					if isElement( vehicle ) then
						player:GiveJobFineByVehicleHealth( vehicle.health )
						vehicle:fix()
					end
				end;
			};

			event_end_name = "PlayerAction_Task_Driver_1_step_3";
		};

	};

	GiveReward = function( player )
		StartAgain( player )
	end;

	no_show_rewards = true;
	no_show_success = true;
}

function StartAgain( player )
	setTimer( function()
		if not isElement( player ) then return end
		triggerEvent( "onJobRequestAnotherTask", player, player, false )
	end, 50, 1 )
end

function CheckPlayerQuestVehicle()
	if not isElement( localPlayer.vehicle ) or localPlayer.vehicle ~= localPlayer:getData( "job_vehicle" ) then
		localPlayer:ShowError( "Ты не в автомобиле Водителя" )
		return false
	end

	if localPlayer.vehicleSeat ~= 0 then
		localPlayer:ShowError( "Ты не водитель автомобиля Водителя" )
		return false
	end

	return true
end